<html>
    <head>
        <link rel="stylesheet" type="text/css" href="img-view.css" />
        <script src="img-view.js" type="text/javascript"></script>
    


<style>
    label.sliderLabel {
        min-width: 5em;
        display:inline-block;
    }

    .slider {
        width: 50em;
    }
    #canvas {
        xxwidth: 600px; 
        xxheight:500px;
        display: inline-block;
        border: 1px solid grey;
    }

    #controls {
        display: inline-block;
        xmin-width: 15em;
        xmax-width: 25em;
        text-align: left;
        vertical-align: top;
    }

</style>
</head>

<script> 
   "use strict";
   
   var GSet =  {
      xoff: 0.0,
      yoff: 0.0,
      contrast: 100,   
      scale: 100,
      bright: 100,
      rotate: 0,
      img: null,
      canvas: null,
      context: null
   };


    function updateControlDispVal(set) {
        toDiv("scaleVal", set.scale.toFixed(2));
        toDiv("xoffVal", set.xoff.toFixed(2));
        toDiv("yoffVal", set.yoff.toFixed(2));
        toDiv("rotateVal", set.rotate.toFixed(3));
        toDiv("contrastVal", set.contrast);
        toDiv("brightVal", set.bright);
    }

    function setControlVal(set) {
        setFormValue("scale", set.scale);
        setFormValue("xoff", set.xoff);
        setFormValue("yoff", set.yoff);
        setFormValue("rotate", set.rotate);
        setFormValue("contrast", set.contrast);
        setFormValue("brightness", set.bright);
        updateControlDispVal(set);
    }

    function readControlVal(set) {
        set.scale = parseFloat(getFormValue("scale", 1.0));
        set.xoff = parseFloat(getFormValue("xoff", 0.0));
        set.yoff = parseFloat(getFormValue("yoff", 0.0));
        set.rotate = parseInt(getFormValue("rotate", 0),10);
        set.contrast = parseInt(getFormValue("contrast", 100),10);
        set.bright = parseInt(getFormValue("brightness", 100),10);
    }

  
    function drawImage(set) {
        var img = set.img;
        var canvas = set.canvas;
        var ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.save();

        // Total Size of Image after scaling 
        // scale < 1.0 will shrink the image
        var effWidth = img.width * set.scale;
        var effHeight = img.height * set.scale;

        // Image Cropping offset only needs to change
        // if the image is larger than the canvas
        var imgTopLeftX = 0.0;
        var imgTopLeftY = 0.0;

        // Amount of Image to render can be size of image 
        // when image is smaller than canvas otherwise
        // we mathematically slice out a portion of it. 
        var imgWidth =  img.width;
        var imgHeigth = img.height;

        // Portlet size to render image the canvas can be 
        // the size of the canvas unless the image is smaller
        // than the canvas.
        var portWidth =  Math.min(canvas.width, effWidth);
        var portHeight = Math.min(canvas.height, effHeight);
        
        // Where to render the image in the canvas
        // always 0 when image is larger than the 
        // canvas otherwise center.   
        var portOffX = 0.0;
        var portOffY = 0.0;

        if (canvas.width > effWidth) {
            portOffX = (canvas.width - effWidth) / 2.0;
            portWidth = effWidth;
            imgWidth = img.width;
        } else if (effWidth > canvas.width) {
            imgTopLeftX = (img.width - canvas.width) * set.xoff;
            imgWidth = canvas.width * set.scale;
        }


        if (canvas.height > effHeight) {
            portOffY = (canvas.height - effHeight) / 2.0;
            portHeight = effHeight;
            imgHeigth = imgHeigth;
        } else if (effHeight > canvas.height) {
            imgTopLeftY = (img.height - canvas.height) * set.yoff;
            imgHeigth = canvas.height * set.scale;
        }

        
        if (set.rotate != 0) {
          //var shapeCenterX = (imgTopLeftX + imgWidth) / 2.0;
          //var shapeCenterY = (imgTopLeftY + imgHeigth) / 2.0;
          //var shapeCenterX = (portOffX + portWidth) / 2.0;
          //var shapeCenterY = (portOffY + portHeight) / 2.0;
          //ctx.translate(shapeCenterX, shapeCenterY);
          var radians = set.rotate * Math.PI / 180.0;
          ctx.translate(canvas.width / 2, canvas.height / 2);
          ctx.rotate( radians);
          ctx.translate(-canvas.width / 2, -canvas.height / 2);
          //ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        }
        var filtStrs = [];
        if (set.contrast != 100) {
          filtStrs.push("contrast(" + set.contrast + "%)");
        }
        if (set.bright != 100) {
          filtStrs.push("brightness(" + set.bright + "%)");
        }
        if (filtStrs.length > 0) {
          ctx.filter = filtStrs.join(" ");
        }
        ctx.drawImage(img, imgTopLeftX, imgTopLeftY, imgWidth, imgHeigth, portOffX, portOffY, portWidth, portHeight);
        ctx.restore();
    }


    function drawToFit(set) {
      var scale =  set.scale = Math.min(set.canvas.width / set.img.width, set.canvas.height / set.img.height);
      drawImage(set);
    }
  
    // Clear setting to default;
    function clearSet(set) {
       set.xoff = 0.0;
       set.yoff = 0.0;
       set.scale = 1.0;
       set.rotate=0;
       set.contrast = 100;
       set.bright=100;    
    }

    function loadAndDisplayImage(canvId, imgUri, set) {
       set.canvas = document.getElementById(canvId); 
       set.context = canvas.getContext('2d'); 
       clearSet(set);
       var img = set.img = new Image();
       img.onload = function() {
         drawToFit(set);
         setControlVal(set);
    
       };
       img.src = imgUri;
    }


    function slideChange(set, obj) {
        readControlVal(set);
        updateControlDispVal(set);
        drawImage(set)
    }

    function getSetJSON(set) {
        var clone = JSON.parse(JSON.stringify(set))
        delete clone.img;
        delete clone.canvas;
        delete clone.context;
        toDiv("JSON_SET", JSON.stringify(clone, 2));
    }

  </script> 

<body onload="loadAndDisplayImage('canvas', 'img/i0241.jpg', GSet)"> 


<canvas  id="canvas" width="800" height="600"></canvas> 

<div id="controls">
    <h3>Controls</h3>

    <label class="sliderLabel" for="scale">Scale</label>
    <input id="scale" type="range" min="0.05" max="2.5" value="0" class="slider"  step="0.01" onInput="slideChange(GSet, this)"/>
    <span id="scaleVal" class="sliderVal"></span>
    <!-- Add + - Icons to scale up or down by 15% from starting value.-->
    <br/>

    <label class="sliderLabel" for="xoffset">X Offset</label>
    <input id="xoff" type="range" min="0.00" max="1.0" value="0.0" step="0.01" class="slider" onInput="slideChange(GSet, this)"/>
    <span id="xoffVal" class="sliderVal"></span>
    <br/>

    <label class="sliderLabel" for="yoffset">Y Offset</label>
    <input id="yoff" type="range" min="0.00" max="1.0" step="0.01" value="0.0" class="slider"  onInput="slideChange(GSet, this)"/>
    <span id="yoffVal" class="sliderVal"></span>
    <br/>

    <label class="sliderLabel" for="rotate">Rotate</label>
    <input id="rotate"  type="range" min="-359" max="359" step="1" value="0" class="slider"  onInput="slideChange(GSet, this)" />
    <span id="rotateVal" class="sliderVal"></span>
    <br/>


    <label class="sliderLabel" for="Contrast">Contrast</label>
    <input id="contrast" type="range" min="25" max="300" value="100" class="slider"  onInput="slideChange(GSet, this)"/>
    <span id="contrastVal" class="sliderVal"></span>
    <br/>
    
    <label class="sliderLabel" for="Brighness">Brightness</label>
    <input id="brightness" type="range" min="25" max="300" value="100" class="slider"  onInput="slideChange(GSet, this)"/>
    <span id="brightVal" class="sliderVal"></span>
    <br/>
        
    <br/><hr>
    <button type="button" id="getjson" onClick="getSetJSON(GSet)">Get JSON</button>

  


        
</div>
</body> 
</html> 